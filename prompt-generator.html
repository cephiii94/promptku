<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Builder - Promptku</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">

    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
</head>
<body>

    <header class="sticky-header">
        <a href="index.html" class="icon-btn">
            <span class="material-icons">arrow_back</span>
            <span class="tooltip">Kembali ke Galeri</span>
        </a>
        <div class="header-title">
            <h1>AI Prompt Builder</h1>
        </div>
        <div style="width: 44px; height: 44px;"></div> </header>

    <div class="container">
        <main class="generator-container" style="max-width: 800px; margin-top: 0;">
            
            <header class="builder-header">
                <h2>Bantu AI Memahami Anda</h2>
                <p>Bantu Gemini Banana memahami keinginan Anda dengan prompt terstruktur.</p>
            </header>
            
            <div class="guide-button-container">
                <button id="openModalButton" class="btn-link">
                    Cara Menggunakan (?)
                </button>
            </div>


            <form id="prompt-form">
                <div class="form-group">
                    <label for="corePrompt">1. Prompt Inti (Subjek Utama)</label>
                    <textarea id="corePrompt" rows="3" placeholder="Misal: 'Seorang wanita', 'Dua anak laki-laki', 'Sebuah kastil di atas bukit'"></textarea>
                    <p class="helper-text">Jelaskan subjek utama atau perintah pengeditan utama.</p>
                </div>

                <div class="form-group">
                    <label>2. Detail Karakter (Opsional)</label>
                    <p class="helper-text" style="margin-bottom: 0.75rem;">Gunakan 'Link Gambar Referensi Wajah' untuk membantu AI mengenali wajah tertentu.</p>
                    <div id="characterContainer">
                        </div>
                    <button type="button" id="addCharacterButton" class="auth-button reset-btn" style="padding: 0.5rem 1rem; margin-top: 0.75rem; width: auto;">
                        <span class="material-icons" style="font-size: 18px;">add</span>
                        <span>Tambah Karakter</span>
                    </button>
                </div>

                <div class="form-group">
                    <label for="actionDetails">3. Aksi & Interaksi (Opsional)</label>
                    <input type="text" id="actionDetails" placeholder="Misal: sedang berlari, tertawa bersama teman, membaca buku di bawah pohon">
                </div>

                <div class="form-group">
                    <label for="atmosphereDetails">4. Suasana & Latar (Opsional)</label>
                    <input type="text" id="atmosphereDetails" placeholder="Misal: di kafe yang ramai, malam hari, hujan, pencahayaan neon, berkabut">
                </div>

                <div class="form-group">
                    <label for="styleMedium">5. Gaya & Medium</label>
                    <select id="styleMedium">
                        <option value="">-- Pilih Gaya (Opsional) --</option>
                        <option value="photorealistic">Fotorealistis (Nyata)</option>
                        <option value="digital art">Seni Digital (Digital Art)</option>
                        <option value="watercolor painting">Lukisan Cat Air</option>
                        <option value="oil painting">Lukisan Cat Minyak</option>
                        <option value="anime style">Gaya Anime / Manga</option>
                        <option value="3D render">3D Render (Seperti Pixar)</option>
                        <option value="pixel art">Pixel Art</option>
                        <option value="line art">Line Art (Sketsa Garis)</option>
                        <option value="in the style of Van Gogh">Gaya Van Gogh</option>
                        <option value="in the style of Picasso">Gaya Picasso</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="quality">6. Kualitas & Resolusi</label>
                    <input type="text" id="quality" placeholder="Misal: '4k', 'sangat detail', 'tajam', 'kualitas tinggi'">
                    <p class="helper-text">Seringkali 'highly detailed' atau '4k' sudah cukup.</p>
                </div>

                <div class="form-group">
                    <label for="negative">7. Prompt Negatif (Hindari Ini)</label>
                    <input type="text" id="negative" placeholder="Misal: 'buram', 'teks', 'watermark', 'kualitas rendah', 'tangan jelek'">
                </div>

                <button type="submit" id="generateButton" class="auth-button generate-btn" style="width: 100%; margin-top: 1rem;">
                    <span id="loadingSpinner" class="material-icons spin hidden" style="margin-right: 0.5rem;">hourglass_top</span>
                    <span id="buttonText">Buat Prompt Cerdas (AI)</span>
                </button>
            </form>

            <div class="form-group" style="margin-top: 2rem; border-top: 1px solid var(--light-gray-border); padding-top: 2rem;">
                <label for="finalPrompt">Hasil Prompt (Siap Digunakan):</label>
                
                <div class="textarea-wrapper"> 
                    
                    <div id="resultLoader" class="hidden">
                        <div class="pulse-wrapper">
                            <div class="skeleton-line" style="width: 75%;"></div>
                            <div class="skeleton-line" style="width: 100%;"></div>
                            <div class="skeleton-line" style="width: 83.33%;"></div>
                        </div>
                    </div>
            
                    <textarea id="finalPrompt" rows="5" readonly placeholder="Hasil prompt akan muncul di sini..."></textarea>
                    
                    <button id="copyButton" class="copy-btn-overlay hidden">
                        <span class="material-icons">content_copy</span>
                        <span class="copy-text">Tersalin!</span>
                    </button>
                </div>
            </div>

        </main>
    </div>

    <div id="howToModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cara Menggunakan</h2>
                <button id="closeModalButton" class="close-btn">&times;</button>
            </div>
            
            <div class="modal-body" style="padding-top: 1rem;">
                <p>Tool ini membantu Anda membuat prompt teks yang deskriptif untuk AI Gambar (Gemini Banana) dari input yang sederhana.</p>
                
                <div style="margin-top: 1rem;">
                    <strong style="font-weight: 600; color: var(--text-dark);">Alur Penggunaan Dasar:</strong>
                    <ol style="list-style: decimal; padding-left: 1.5rem; margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem;">
                        <li><strong>Prompt Inti:</strong> Isi dengan subjek utama adegan.</li>
                        <li><strong>Detail Karakter:</strong> Klik "Tambah Karakter (+)" untuk setiap karakter utama.</li>
                        <li><strong>Aksi & Suasana:</strong> Jelaskan apa yang terjadi dan bagaimana suasananya.</li>
                        <li><strong>Gaya & Kualitas:</strong> Pilih gaya (misal: "Fotorealistis") dan kualitas.</li>
                        <li>Klik <strong>"Buat Prompt Cerdas (AI)"</strong>.</li>
                    </ol>
                </div>

                <div class="modal-notice-box">
                    <strong>PENTING: Cara Menggunakan Referensi Wajah</strong>
                    <p>Agar AI bisa menghasilkan wajah yang mirip (misal: Vanno atau Varren):</p>
                    <ol style="list-style: decimal; padding-left: 1.5rem; margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem;">
                        <li><strong>Upload Gambar:</strong> Buka <a href="https://imgur.com/upload" target="_blank">Imgur.com</a>. Upload foto referensi wajah Anda.</li>
                        <li><strong>Salin Link:</strong> Klik kanan gambar dan pilih <strong>"Copy Image Address"</strong> (Link harus berakhir .jpg, .png, dll).</li>
                        <li><strong>Deskripsikan Karakter:</strong> Isi *textarea* "Detail Karakter" (misal: "Vanno, anak laki-laki, tertawa").</li>
                        <li><strong>Tempel Link:</strong> Tempel link dari Imgur ke kotak <strong>"Link Gambar Referensi Wajah"</strong>.</li>
                    </ol>
                </div>

            </div>
        </div>
    </div>
    <script>
        // --- Konstanta Modal ---
        const openModalButton = document.getElementById('openModalButton');
        const closeModalButton = document.getElementById('closeModalButton');
        const howToModal = document.getElementById('howToModal');
        
        // --- Konstanta Form ---
        const generateButton = document.getElementById('generateButton');
        const copyButton = document.getElementById('copyButton');
        const corePromptEl = document.getElementById('corePrompt');
        const styleMediumEl = document.getElementById('styleMedium');
        const addCharacterButton = document.getElementById('addCharacterButton');
        const characterContainer = document.getElementById('characterContainer');
        const actionDetailsEl = document.getElementById('actionDetails'); 
        const atmosphereDetailsEl = document.getElementById('atmosphereDetails');
        const qualityEl = document.getElementById('quality');
        const negativeEl = document.getElementById('negative');
        const finalPromptEl = document.getElementById('finalPrompt');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');
        const resultLoaderEl = document.getElementById('resultLoader');

        // --- Event Listener untuk Modal (Menggunakan kelas .modal dari styles.css) ---
        openModalButton.addEventListener('click', () => {
            howToModal.style.display = 'flex';
        });

        closeModalButton.addEventListener('click', () => {
            howToModal.style.display = 'none';
        });

        howToModal.addEventListener('click', (event) => {
            if (event.target === howToModal) {
                howToModal.style.display = 'none';
            }
        });
        // ----------------------------------------


        // --- [PERUBAHAN] FUNGSI Menambah Field Karakter (Menggunakan kelas CSS baru) ---
        let characterCounter = 0; 
        function addNewCharacterField() {
            characterCounter++;
            const charId = `character-${characterCounter}`;

            // [PERUBAHAN] Menggunakan kelas CSS baru: .character-field-wrapper
            const fieldWrapper = document.createElement('div');
            fieldWrapper.className = 'character-field-wrapper'; 

            const detailTextarea = document.createElement('textarea');
            detailTextarea.id = `${charId}-detail`;
            detailTextarea.className = 'character-field'; // Ini adalah textarea
            detailTextarea.placeholder = `Detail Karakter #${characterCounter} (misal: pria, jaket kulit, rambut hitam)`;
            detailTextarea.rows = 2;

            const refLinkInput = document.createElement('input');
            refLinkInput.type = 'url'; 
            refLinkInput.id = `${charId}-ref-link`;
            refLinkInput.className = 'character-ref-link'; // Ini adalah input
            refLinkInput.placeholder = 'Link Gambar Referensi Wajah (Opsional)';

            // [PERUBAHAN] Menggunakan kelas CSS baru: .remove-char-btn
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-char-btn';
            removeButton.innerHTML = '&times;'; 
            removeButton.addEventListener('click', () => {
                fieldWrapper.remove();
            });

            fieldWrapper.appendChild(detailTextarea);
            fieldWrapper.appendChild(refLinkInput); 
            fieldWrapper.appendChild(removeButton);
            characterContainer.appendChild(fieldWrapper);
        }

        addCharacterButton.addEventListener('click', addNewCharacterField);
        addNewCharacterField(); // Tambah satu saat dimuat

        // === FUNGSI PANGGIL NETLIFY (Logika tetap sama) ===
        document.getElementById('prompt-form').addEventListener('submit', async (e) => {
            e.preventDefault(); // Mencegah submit form standar

            const core = corePromptEl.value.trim();
            const style = styleMediumEl.value;

            const characterFields = document.querySelectorAll('.character-field');
            const characterRefLinks = document.querySelectorAll('.character-ref-link');
            const characterDetailsList = [];
            
            characterFields.forEach((field, index) => {
                const detail = field.value.trim();
                const refLink = characterRefLinks[index] ? characterRefLinks[index].value.trim() : '';
                if (detail) {
                    let characterDescription = `Karakter ${index + 1}: ${detail}`;
                    if (refLink) {
                        characterDescription += ` (referensi wajah: ${refLink})`; 
                    }
                    characterDetailsList.push(characterDescription);
                }
            });
            const characterDetails = characterDetailsList.join('\n');
            
            const actionDetails = actionDetailsEl.value.trim();
            const atmosphereDetails = atmosphereDetailsEl.value.trim();
            const quality = qualityEl.value.trim();
            const negative = negativeEl.value.trim();

            if (!core) {
                finalPromptEl.value = "Harap isi 'Prompt Inti' terlebih dahulu.";
                return;
            }

            // Tampilkan status loading
            generateButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = 'Memproses AI...';
            finalPromptEl.classList.add('hidden'); // Sembunyikan textarea
            copyButton.classList.add('hidden'); // Sembunyikan tombol salin
            resultLoaderEl.classList.remove('hidden'); // Tampilkan skeleton

            const functionEndpoint = '/.netlify/functions/generate-prompt';
            const payload = { core, characterDetails, actionDetails, atmosphereDetails, style, quality, negative };

            try {
                const response = await fetch(functionEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `Server error (${response.status})`);
                }

                const result = await response.json();
                
                if (result.text) {
                    finalPromptEl.value = result.text.trim();
                } else {
                    finalPromptEl.value = 'Maaf, server tidak memberikan respons yang valid.';
                }

            } catch (error) {
                finalPromptEl.value = `Gagal terhubung ke server: ${error.message}.`;
            } finally {
                // Sembunyikan status loading
                generateButton.disabled = false;
                loadingSpinner.classList.add('hidden');
                buttonText.textContent = 'Buat Prompt Cerdas (AI)';
                
                resultLoaderEl.classList.add('hidden'); // Sembunyikan skeleton
                finalPromptEl.classList.remove('hidden'); // Tampilkan textarea
                copyButton.classList.remove('hidden'); // Tampilkan tombol salin
            }
        });

        // --- Fungsi Salin (Disesuaikan untuk tombol baru) ---
        copyButton.addEventListener('click', () => {
            if (finalPromptEl.classList.contains('hidden') || !finalPromptEl.value || finalPromptEl.value.startsWith("Harap isi")) {
                return;
            }

            finalPromptEl.select();
            finalPromptEl.setSelectionRange(0, 99999); 
            
            try {
                document.execCommand('copy');
                copyButton.classList.add('copied'); // Gunakan kelas 'copied' dari styles.css
                
                setTimeout(() => {
                    copyButton.classList.remove('copied');
                }, 1500);

            } catch (err) {
                console.error('Gagal menyalin teks: ', err);
            }
            
            window.getSelection().removeAllRanges();
        });
    </script>

</body>
</html>