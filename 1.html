<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Prompt</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --soft-blue-bg: #EBF8FF;
            --primary-blue: #38BDF8;
            --primary-blue-dark: #0EA5E9;
            --text-dark: #1F2937;
            --text-medium: #4B5563;
            --primary-green: #059669;
            --success-green: #10B981;
            --light-gray-bg: #F9FAFB;
            --light-gray-border: #E5E7EB;
            --white: #FFFFFF;
            --danger-red: #EF4444;
            --font-family-sans: 'Inter', sans-serif;
            --header-height-desktop: 80px;
            --header-height-mobile: 70px;
            --border-radius-sm: 0.375rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 1rem;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family-sans);
            background-color: var(--soft-blue-bg);
            color: var(--text-dark);
            line-height: 1.6;
            padding-top: var(--header-height-desktop);
        }
        .container {
            width: 100%;
            max-width: 1280px;
            margin-left: auto;
            margin-right: auto;
            padding: 2rem 1rem;
        }
        .prompt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
        }
        .sticky-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background-color: var(--white);
            box-shadow: var(--shadow-md);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .header-title h1 { font-size: 1.2rem; color: var(--primary-blue-dark); white-space: nowrap; }
        .header-controls { display: flex; align-items: center; gap: 0.5rem; }
        .filter-input, .filter-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--light-gray-border);
            border-radius: var(--border-radius-md);
            font-size: 0.9rem;
        }
        .search-form-overlay {
            display: none; position: absolute; top: 100%; left: 0;
            width: 100%; background: var(--white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 0.75rem 1rem; z-index: 1002;
            border-bottom: 1px solid var(--light-gray-border);
        }
        .search-form-overlay.active { display: block; }
        .card {
            position: relative; background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden; display: flex; flex-direction: column;
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .card-image-container {
            position: relative; width: 100%; aspect-ratio: 16 / 9;
            overflow: hidden; background-color: var(--light-gray-bg);
        }
        .card-image-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .image-overlay-text {
            position: absolute; top: 0.75rem; left: 0.75rem;
            background-color: rgba(0, 0, 0, 0.5); color: white;
            padding: 0.25rem 0.75rem; border-radius: 999px;
            font-size: 0.75rem; font-weight: 500;
            backdrop-filter: blur(4px);
        }
        .card-content { padding: 1.25rem; display: flex; flex-direction: column; gap: 1rem; flex-grow: 1; }
        .card-title { font-size: 1.2rem; font-weight: 700; color: var(--primary-blue-dark); }
        .card-user { font-size: 0.8rem; color: var(--text-medium); font-style: italic; }
        .prompt-textarea {
            width: 100%; height: 7rem; padding: 0.75rem;
            background-color: #F3F4F6; border: 1px solid var(--light-gray-border);
            border-radius: var(--border-radius-md); font-family: inherit;
            font-size: 0.9rem; resize: none;
        }
        .card-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: auto; padding-top: 0.5rem; }
        .tag {
            font-size: 0.75rem; font-weight: 500; color: var(--text-medium);
            background-color: transparent; padding: 0.25rem 0.75rem;
            border-radius: 999px; border: 1px solid var(--light-gray-border);
            cursor: pointer; transition: all 0.2s ease;
        }
        .tag:hover { background-color: var(--primary-blue); color: var(--white); border-color: var(--primary-blue); }
        .tag-category {
            background-color: var(--soft-blue-bg); border-color: var(--primary-blue);
            color: var(--primary-blue-dark); font-weight: 600;
        }
        .card-actions {
            display: flex; justify-content: flex-end; gap: 0.5rem;
            margin-top: 1rem; border-top: 1px solid var(--light-gray-border); padding-top: 1rem;
        }
        .action-btn {
            width: 36px; height: 36px; padding: 0; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer; color: white; font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .action-btn:hover { transform: scale(1.1) translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .edit-btn { background-color: var(--primary-blue); }
        .edit-btn:hover { background-color: var(--primary-blue-dark); }
        .delete-btn { background-color: var(--danger-red); }
        .delete-btn:hover { opacity: 0.8; }
        .modal {
            display: none; position: fixed; z-index: 1001;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--white); padding: 20px;
            width: 90%; max-width: 500px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; border-bottom: 1px solid var(--light-gray-border);
            padding-bottom: 1rem;
        }
        .modal-header h2 { color: var(--primary-blue-dark); }
        .modal-body form { display: flex; flex-direction: column; gap: 1rem; }
        .modal-body input, .modal-body textarea {
            width: 100%; padding: 0.75rem;
            border: 1px solid var(--light-gray-border);
            border-radius: var(--border-radius-md);
        }
        .modal-body button { align-self: flex-end; }
        .form-row { display: flex; flex-wrap: wrap; gap: 1rem; }
        .form-group { flex: 1; min-width: 150px; }
        .form-group label {
            display: block; margin-bottom: 0.25rem;
            font-size: 0.875rem; font-weight: 500;
            color: var(--text-medium);
        }
        .auth-button {
            padding: 0.5rem 1rem; border: none; border-radius: var(--border-radius-md);
            cursor: pointer; font-weight: 500; transition: background-color 0.2s;
            display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center;
        }
        .login-btn { background-color: var(--primary-blue); color: white; }
        .copy-btn {
            background: none; border: 1px solid var(--light-gray-border);
            border-radius: var(--border-radius-sm); padding: 0.25rem 0.5rem;
            cursor: pointer; display: flex; align-items: center; gap: 0.35rem;
            font-size: 0.75rem; color: var(--text-medium); transition: all 0.2s ease;
            align-self: flex-end; margin-bottom: 0.5rem;
        }
        .copy-btn.copied { background-color: var(--success-green); color: white; border-color: var(--success-green); }
        .copy-btn svg { width: 14px; height: 14px; }
        .icon-btn, .auth-icon-btn {
            background: var(--primary-blue); border: none; border-radius: var(--border-radius-md);
            padding: 0.5rem; cursor: pointer; display: flex; align-items: center;
            justify-content: center; position: relative; color: #fff;
            transition: background-color 0.2s, opacity 0.2s;
        }
        #add-prompt-link-mobile { background-color: var(--primary-green); }
        .auth-icon-btn.logout { background-color: var(--danger-red); }
        .tooltip {
            visibility: hidden; opacity: 0; background: #333; color: #fff;
            text-align: center; border-radius: var(--border-radius-sm); padding: 0.25rem 0.7rem;
            position: absolute; z-index: 10; left: 50%; top: 110%;
            transform: translateX(-50%); font-size: 0.85rem; white-space: nowrap;
            transition: opacity 0.2s; pointer-events: none;
        }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; border: none; background: none; }
        @media (hover: hover) { .icon-btn:hover .tooltip, .auth-icon-btn:hover .tooltip { visibility: visible; opacity: 1; } }
        @media (max-width: 768px) {
            body { padding-top: var(--header-height-mobile); }
            .sticky-header { padding: 0.5rem 0.5rem; }
            .header-title h1 { font-size: 1rem; }
            .container { padding: 1rem 0.5rem; }
            .prompt-grid { grid-template-columns: 1fr; gap: 1rem; }
            .header-controls .filter-input, .header-controls #category-filter { display: none; }
            .header-controls .icon-btn, .header-controls .auth-icon-btn { display: flex; }
        }
        @media (min-width: 769px) { #search-btn { display: none; } .search-form-overlay { display: none !important; } }
    </style>
</head>
<body>

    <header class="sticky-header">
        <div class="header-title"><h1>Galeri Prompt Tuan Cecep</h1></div>
        <div class="header-controls">
            <select id="category-filter" class="filter-select">
                <option value="all">Semua Kategori</option>
            </select>
            <input type="text" id="filter-input" class="filter-input" placeholder="Cari berdasarkan judul...">
            <button id="search-btn" class="search-icon-btn icon-btn" type="button"><span class="material-icons">search</span><span class="tooltip">Cari Prompt</span></button>
            <button id="add-prompt-link-mobile" class="icon-btn" type="button"><span class="material-icons">add</span><span class="tooltip">Tambah Prompt</span></button>
            <div id="auth-container-mobile"></div>
        </div>
        <div id="search-form-overlay" class="search-form-overlay"><input type="text" id="filter-input-mobile" class="filter-input" placeholder="Cari berdasarkan judul..."></div>
    </header>

    <div class="container"><main class="prompt-grid" id="prompt-grid"><p>Memuat prompt...</p></main></div>

    <div id="prompt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Tambah Prompt Baru</h2>
                <button class="close-btn" data-modal="prompt-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="prompt-form">
                    <input type="hidden" id="prompt-id">
                    <input type="text" id="prompt-title" placeholder="Judul" required>
                    <div class="form-row">
                        <div class="form-group"><label for="prompt-category">Kategori</label><input type="text" id="prompt-category" placeholder="cth: Karakter" required></div>
                        <div class="form-group"><label for="prompt-tags">Tags (pisahkan dengan koma)</label><input type="text" id="prompt-tags" placeholder="cth: anime, fantasi"></div>
                    </div>
                    <textarea id="prompt-text" rows="4" placeholder="Isi Prompt" required></textarea>
                    <input type="url" id="prompt-imageUrl" placeholder="URL Gambar Hasil (dari Google Drive)" required>
                    <button type="submit" class="auth-button login-btn">Simpan</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login Admin</h2>
                <button class="close-btn" data-modal="login-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" class="auth-button login-btn">Login</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK (v8, non-modular) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =========================================================================
            // 1. SETUP & CONFIGURATION
            // =========================================================================
            const firebaseConfig = {
                apiKey: "AIzaSyD5dhh4a3835uJGxxvKL27KcTAtu0f7bT4",
                authDomain: "all-auth-1509.firebaseapp.com",
                projectId: "all-auth-1509",
                storageBucket: "all-auth-1509.appspot.com",
                messagingSenderId: "23681152443",
                appId: "1:23681152443:web:8f86c9b89e14c90692809e",
                measurementId: "G-D3Y0WHY83V"
            };
            
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const auth = firebase.auth();
            const db = firebase.firestore();

            // =========================================================================
            // 2. DOM ELEMENT SELECTORS & HELPER
            // =========================================================================
            const promptGrid = document.getElementById('prompt-grid');
            const categoryFilter = document.getElementById('category-filter');
            const textFilterDesktop = document.getElementById('filter-input');
            const textFilterMobile = document.getElementById('filter-input-mobile');
            const addPromptLinkMobile = document.getElementById('add-prompt-link-mobile');
            const authContainerMobile = document.getElementById('auth-container-mobile');
            const searchBtn = document.getElementById('search-btn');
            const searchOverlay = document.getElementById('search-form-overlay');
            const loginForm = document.getElementById('login-form');
            const promptForm = document.getElementById('prompt-form');

            const convertGoogleDriveUrl = (url) => {
                if (!url || typeof url !== 'string') return '';
                const regex = /drive\.google\.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/;
                const match = url.match(regex);
                if (match && match[1]) {
                    const fileId = match[1];
                    return `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
                return url;
            };

            // =========================================================================
            // 3. APPLICATION STATE
            // =========================================================================
            let allPrompts = [];
            let currentUser = null;

            // =========================================================================
            // 4. DATA FETCHING & FILTERING
            // =========================================================================
            const fetchAndRenderPrompts = async () => {
                try {
                    const snapshot = await db.collection("prompts").orderBy("title").get();
                    allPrompts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateCategoryFilter();
                    applyFilters();
                } catch (error) {
                    console.error("Gagal mengambil data: ", error);
                    promptGrid.innerHTML = `<p>Gagal memuat data. Periksa aturan keamanan Firestore Anda.</p>`;
                }
            };

            const populateCategoryFilter = () => {
                const categories = [...new Set(allPrompts.map(p => p.category).filter(Boolean))].sort();
                categoryFilter.innerHTML = '<option value="all">Semua Kategori</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            };

            const applyFilters = () => {
                const category = categoryFilter.value;
                const searchTerm = (window.innerWidth > 768 ? textFilterDesktop.value : textFilterMobile.value).toLowerCase();
                let filtered = allPrompts;
                if (category !== 'all') {
                    filtered = filtered.filter(p => p.category === category);
                }
                if (searchTerm) {
                    filtered = filtered.filter(p =>
                        p.title.toLowerCase().includes(searchTerm) ||
                        (p.tags && p.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                    );
                }
                renderPrompts(filtered);
            };

            // =========================================================================
            // 5. RENDERING LOGIC
            // =========================================================================
            const renderPrompts = (promptsToRender) => {
                if (!promptsToRender.length) {
                    promptGrid.innerHTML = '<p>Tidak ada prompt yang ditemukan.</p>';
                    return;
                }
                const fallbackImage = "data:image/svg+xml,%3Csvg width='400' height='225' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 225' preserveAspectRatio='none'%3E%3Cdefs%3E%3Cstyle type='text/css'%3E%23holder text %7B fill:%23999;font-weight:normal;font-family:var(--font-family-sans);font-size:20pt %7D %3C/style%3E%3C/defs%3E%3Cg%3E%3Crect width='400' height='225' fill='%23E5E7EB'%3E%3C/rect%3E%3Cg%3E%3Ctext x='105.32' y='121.5'%3EGambar Gagal Dimuat%3C/text%3E%3C/g%3E%3C/g%3E%3C/svg%3E";
                const allCardsHTML = promptsToRender.map(prompt => {
                    const adminActions = currentUser ? `
                        <div class="card-actions">
                            <button class="action-btn edit-btn" data-id="${prompt.id}"><span class="material-icons">edit</span><span class="tooltip">Edit</span></button>
                            <button class="action-btn delete-btn" data-id="${prompt.id}"><span class="material-icons">delete</span><span class="tooltip">Hapus</span></button>
                        </div>` : '';
                    const categoryTag = prompt.category ? `<span class="tag tag-category" data-filter-type="category" data-filter-value="${prompt.category}">${prompt.category}</span>` : '';
                    const otherTags = (prompt.tags && Array.isArray(prompt.tags)) ? prompt.tags.map(tag => `<span class="tag" data-filter-type="tag" data-filter-value="${tag}">${tag}</span>`).join('') : '';
                    const imageUrl = convertGoogleDriveUrl(prompt.imageUrl);
                    return `
                        <div class="card">
                            <div class="card-image-container">
                                <img src="${imageUrl}" alt="Hasil gambar dari prompt: ${prompt.title}" onerror="this.onerror=null;this.src='${fallbackImage}';">
                                <span class="image-overlay-text">Hasil Generator</span>
                            </div>
                            <div class="card-content">
                                <div class="card-header"><div><h3 class="card-title">${prompt.title}</h3><span class="card-user">by User</span></div></div>
                                <button class="copy-btn" data-prompt-text="${encodeURIComponent(prompt.promptText)}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>
                                    <span class="copy-text">Salin</span>
                                </button>
                                <div class="prompt-wrapper"><textarea readonly class="prompt-textarea">${prompt.promptText}</textarea></div>
                                <div class="card-tags">${categoryTag}${otherTags}</div>
                                ${adminActions}
                            </div>
                        </div>`;
                }).join('');
                promptGrid.innerHTML = allCardsHTML;
            };

            // =========================================================================
            // 6. CRUD & AUTH OPERATIONS
            // =========================================================================
            const loginUser = (email, password) => {
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .then(() => hideModal('login-modal'))
                    .catch(error => alert(`Login Gagal: ${error.message}`));
            };

            const logoutUser = () => firebase.auth().signOut();

            const savePrompt = async (formData) => {
                try {
                    if (formData.tags && typeof formData.tags === 'string') {
                        formData.tags = formData.tags.split(',').map(tag => tag.trim()).filter(Boolean);
                    } else if (!formData.tags) { formData.tags = []; }

                    const { id, ...data } = formData;
                    if (id) {
                        await db.collection("prompts").doc(id).update(data);
                    } else {
                        await db.collection("prompts").add(data);
                    }
                    hideModal('prompt-modal');
                    await fetchAndRenderPrompts();
                } catch (error) {
                    console.error("Gagal menyimpan prompt: ", error);
                    alert("Gagal menyimpan prompt.");
                }
            };

            const deletePrompt = async (id) => {
                if (confirm("Apakah Anda yakin ingin menghapus prompt ini?")) {
                    try {
                        await db.collection("prompts").doc(id).delete();
                        await fetchAndRenderPrompts();
                    } catch (error) {
                        console.error("Gagal menghapus prompt: ", error);
                        alert("Gagal menghapus prompt.");
                    }
                }
            };

            // =========================================================================
            // 7. MODAL & UI LOGIC
            // =========================================================================
            const showModal = (modalId, data = null) => {
                const modal = document.getElementById(modalId);
                if (modalId === 'prompt-modal') {
                    promptForm.reset();
                    document.getElementById('modal-title').innerText = data ? 'Edit Prompt' : 'Tambah Prompt Baru';
                    document.getElementById('prompt-id').value = data?.id || '';
                    document.getElementById('prompt-title').value = data?.title || '';
                    document.getElementById('prompt-category').value = data?.category || '';
                    document.getElementById('prompt-text').value = data?.promptText || '';
                    document.getElementById('prompt-imageUrl').value = data?.imageUrl || '';
                    document.getElementById('prompt-tags').value = (data?.tags && Array.isArray(data.tags)) ? data.tags.join(', ') : '';
                }
                modal.style.display = 'flex';
            };

            const hideModal = (modalId) => {
                document.getElementById(modalId).style.display = 'none';
            };

            const updateAuthStateUI = (user) => {
                if (user) {
                    authContainerMobile.innerHTML = `<button class="auth-icon-btn logout" id="logout-btn-mobile-icon"><span class="material-icons">logout</span><span class="tooltip">Logout</span></button>`;
                    document.getElementById('logout-btn-mobile-icon').addEventListener('click', logoutUser);
                    addPromptLinkMobile.style.display = 'flex';
                } else {
                    authContainerMobile.innerHTML = `<button class="auth-icon-btn" id="login-btn-mobile-icon"><span class="material-icons">login</span><span class="tooltip">Login</span></button>`;
                    document.getElementById('login-btn-mobile-icon').addEventListener('click', () => showModal('login-modal'));
                    addPromptLinkMobile.style.display = 'none';
                }
            };

            // =========================================================================
            // 8. EVENT LISTENERS
            // =========================================================================
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loginUser(document.getElementById('login-email').value, document.getElementById('login-password').value);
            });

            promptForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = {
                    id: document.getElementById('prompt-id').value,
                    title: document.getElementById('prompt-title').value,
                    category: document.getElementById('prompt-category').value,
                    promptText: document.getElementById('prompt-text').value,
                    imageUrl: document.getElementById('prompt-imageUrl').value,
                    tags: document.getElementById('prompt-tags').value,
                };
                savePrompt(formData);
            });

            promptGrid.addEventListener('click', (e) => {
                const target = e.target;
                const editBtn = target.closest('.edit-btn');
                const deleteBtn = target.closest('.delete-btn');
                const copyBtn = target.closest('.copy-btn');
                const clickedTag = target.closest('.tag');

                if (clickedTag) {
                    const { filterType, filterValue } = clickedTag.dataset;
                    textFilterDesktop.value = '';
                    textFilterMobile.value = '';
                    if (filterType === 'category') categoryFilter.value = filterValue;
                    else {
                        categoryFilter.value = 'all';
                        textFilterDesktop.value = filterValue;
                        textFilterMobile.value = filterValue;
                    }
                    applyFilters();
                    window.scrollTo(0, 0);
                    return;
                }
                if (editBtn) {
                    const promptToEdit = allPrompts.find(p => p.id === editBtn.dataset.id);
                    if (promptToEdit) showModal('prompt-modal', promptToEdit);
                    return;
                }
                if (deleteBtn) {
                    deletePrompt(deleteBtn.dataset.id);
                    return;
                }
                if (copyBtn) {
                    const textToCopy = decodeURIComponent(copyBtn.dataset.promptText);
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        const textSpan = copyBtn.querySelector('.copy-text');
                        if (!textSpan) return;
                        const originalText = textSpan.textContent;
                        copyBtn.classList.add('copied');
                        textSpan.textContent = 'Tersalin!';
                        setTimeout(() => {
                            copyBtn.classList.remove('copied');
                            textSpan.textContent = originalText;
                        }, 2000);
                    }).catch(err => console.error('Gagal menyalin: ', err));
                }
            });
            
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', () => hideModal(btn.dataset.modal));
            });

            searchBtn.addEventListener('click', () => {
                searchOverlay.classList.toggle('active');
                if (searchOverlay.classList.contains('active')) textFilterMobile.focus();
            });

            [categoryFilter, textFilterDesktop, textFilterMobile].forEach(el => {
                el.addEventListener('input', applyFilters);
            });

            addPromptLinkMobile.addEventListener('click', (e) => {
                e.preventDefault();
                showModal('prompt-modal');
            });

            // =========================================================================
            // 9. INITIALIZATION
            // =========================================================================
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateAuthStateUI(user);
                applyFilters();
            });

            fetchAndRenderPrompts();
        });
    </script>
</body>
</html>

