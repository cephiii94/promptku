<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Generator - Promptku</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">

    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
</head>
<body>

    <header class="sticky-header">
        <a href="index.html" class="icon-btn" style="background-color: var(--primary-blue); border: none; padding: 0.5rem;">
            <span class="material-icons">arrow_back</span>
            <span class="tooltip">Kembali ke Galeri</span>
        </a>
        
        <div class="header-title">
            <h1>Image Generator</h1>
        </div>
        
        <div style="width: 44px; height: 44px;"></div>
    </header>

    <div class="container">
        <main class="generator-container">
            
            <form id="generator-form">
                <div class="form-group">
                    <label for="prompt-input">Prompt Anda:</label>
                    <textarea id="prompt-input" rows="8" placeholder="Tulis prompt Anda di sini atau dapatkan dari galeri..."></textarea>
                </div>

                <button type="submit" class="auth-button generate-btn" style="width: 100%;">
                    <span class="material-icons">auto_awesome</span>
                    <span>Generate Image</span>
                </button>
            </form>

            <div class="output-container">
                <h2>Hasil Gambar</h2>
                
                <div id="image-output-placeholder">
                    <span class="material-icons" style="font-size: 48px;">image</span>
                    <p>Hasil gambar akan muncul di sini</p>
                </div>
                
                </div>

        </main>
    </div>

    <footer class="site-footer">
        <div class="container">
            <p>&copy; <span id="current-year"></span> Galeri Prompt Banana | Dibuat Dengan Cinta &hearts;</p>
        </div>
    </footer>

<script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Logika untuk mengambil prompt dari URL (TETAP SAMA)
            const getPromptFromURL = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const prompt = urlParams.get('prompt');
                if (prompt) {
                    // Masukkan prompt ke textarea
                    document.getElementById('prompt-input').value = decodeURIComponent(prompt);
                }
            };
            
            // Panggil fungsi saat halaman dimuat
            getPromptFromURL();

            // 2. Logika untuk submit form (DIGANTI DENGAN KODE NETLIFY)
            const generatorForm = document.getElementById('generator-form');
            const outputPlaceholder = document.getElementById('image-output-placeholder');

            // [PERUBAHAN] Tambahkan 'async' di sini
            generatorForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // Mencegah form submit
                
                const promptText = document.getElementById('prompt-input').value;

                if (!promptText.trim()) {
                    alert("Mohon masukkan prompt terlebih dahulu.");
                    return;
                }

                // Tampilkan status loading
                outputPlaceholder.innerHTML = `
                    <span class="material-icons spin">hourglass_top</span>
                    <p>Sedang men-generate... mohon tunggu...</p>
                `;

                // ===============================================
                // === [BARU] Logika Fetch ke Netlify Function ===
                // ===============================================
                
                try {
                    // 1. Panggil Netlify Function Anda
                    // Pastikan '/.netlify/functions/generate-image' sudah benar
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        // 2. Kirim prompt sebagai JSON
                        body: JSON.stringify({ prompt: promptText }),
                    });

                    if (!response.ok) {
                        // Tangkap error jika server Netlify gagal (misal: error 500)
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Server error: ${response.status}`);
                    }

                    // 3. Ambil data (URL gambar) dari balasan
                    const data = await response.json();

                    // Pastikan balasan dari Netlify Function Anda adalah { "imageUrl": "..." }
                    if (!data.imageUrl) {
                         // Tangkap jika format balasan tidak sesuai
                         throw new Error("Format balasan dari server tidak valid.");
                    }
                    
                    // 4. Tampilkan gambar
                    outputPlaceholder.innerHTML = `
                        <img src="${data.imageUrl}" alt="Generated Image" style="max-width: 100%; height: auto; border-radius: 8px;">
                    `;

                } catch (error) {
                    // 5. Tampilkan pesan error jika terjadi masalah
                    console.error("Gagal men-generate gambar:", error);
                    outputPlaceholder.innerHTML = `
                        <span class="material-icons" style="color: #EF4444;">error_outline</span>
                        <p>Maaf, terjadi kesalahan: ${error.message}</p>
                    `;
                }
            });

            // 3. Logika footer (tahun) (TETAP SAMA)
            document.getElementById('current-year').textContent = new Date().getFullYear();
        });
    </script>
    
</body>
</html>